{% extends "base.html" %}

{% block title %}Today's Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Welcome back, {{ current_user.name.split()[0] }}!</h1>
    {% if daily_quote %}
        <p class="motivational-quote">"{{ daily_quote }}"</p>
    {% endif %}
</div>

<div class="dashboard-grid">
    <div class="card stat-card">
        <h3>Calories Eaten</h3>
        <div class="stat-value" id="calories-eaten">{{ total_calories|int }}</div>
        <small>/ {{ daily_goal|int }} kcal</small>
    </div>
    <div class="card stat-card">
        <h3>Calories Burned</h3>
        <div class="stat-value" id="calories-burned">{{ workout_calories|int }}</div>
        <small>kcal</small>
    </div>
    <div class="card stat-card">
        <h3>Net Calories</h3>
        <div class="stat-value" id="calories-net">{{ (total_calories - workout_calories)|int }}</div>
        <small>kcal</small>
    </div>
    <div class="card stat-card">
        <h3>Streak</h3>
        <div class="stat-value" id="streak-value">{{ streak }}</div>
        <small>Days</small>
    </div>
</div>

<div class="ai-plans-container">
    <div class="floating-export-button">
        <button id="exportBtn" class="btn btn-primary"><i class="fas fa-download"></i></button>
    </div>

    <div class="ai-plan-card">
        <div class="ai-plan-header">
            <div class="ai-plan-title">
                <i class="fas fa-utensils"></i>
                <h2>Today's Diet</h2>
            </div>
            <div id="diet-date" class="plan-date"></div>
        </div>
        <ul class="plan-item-list" id="diet-list">
            {{ diet_plan_html|safe }}
        </ul>

        {% if user_meals_today %}
        <div class="user-logged-section">
            <h3 class="user-logged-title">Your Logged Meals</h3>
            <ul class="plan-item-list">
                {% for meal in user_meals_today %}
                <li class="plan-item completed">
                    <input type="checkbox" checked disabled>
                    <div class="item-details">
                        <div class="item-name">{{ meal.name }}</div>
                        <div class="item-info">{{ meal.calories|int }} kcal</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <div class="ai-plan-card">
        <div class="ai-plan-header">
            <div class="ai-plan-title">
                <i class="fas fa-dumbbell"></i>
                <h2>Today's Workout</h2>
            </div>
            <div id="workout-date" class="plan-date"></div>
        </div>
        <ul class="plan-item-list" id="workout-list">
             {{ workout_plan_html|safe }}
        </ul>

        {% if user_workouts_today %}
        <div class="user-logged-section">
            <h3 class="user-logged-title">Your Logged Workouts</h3>
            <ul class="plan-item-list">
                {% for workout in user_workouts_today %}
                <li class="plan-item completed">
                    <input type="checkbox" checked disabled>
                    <div class="item-details">
                        <div class="item-name">{{ workout.type }}</div>
                        <div class="item-info">{{ workout.calories_burned|int }} kcal burned</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<div class="charts-grid">
    <div class="card">
        {% if weight_graph_img %}
            <img src="{{ weight_graph_img }}" alt="Weight progress graph" style="width: 100%; height: auto; border-radius: 0.5rem;">
        {% else %}
            <div style="text-align: center; padding: 4rem 1rem;">
                <p>Log your weight to see your progress chart here.</p>
            </div>
        {% endif %}
    </div>
    <div class="card">
        {% if calorie_graph_img %}
            <img src="{{ calorie_graph_img }}" alt="Calorie trend graph" style="width: 100%; height: auto; border-radius: 0.5rem;">
        {% else %}
            <div style="text-align: center; padding: 4rem 1rem;">
                <p>Log your meals to see your calorie trend here.</p>
            </div>
        {% endif %}
    </div>
</div>

<div id="exportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content card">
        <div class="modal-header">
            <h2>Export Options</h2>
            <button id="closeModalBtn" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p>Choose a format to download your data.</p>
            <div class="export-options">
                <a href="{{ url_for('export_pdf') }}" class="export-card">
                    <i class="fas fa-file-pdf"></i>
                    <h3>Daily Plan</h3>
                    <span>(PDF)</span>
                </a>
                <a href="{{ url_for('export_excel') }}" class="export-card">
    <i class="fas fa-file-excel"></i>
    <h3>Today's Plan</h3>
    <span>(Excel)</span>
</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    function setTodaysDate() {
        const today = new Date();
        const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };
        const formattedDate = today.toLocaleDateString('en-US', dateOptions);
        const dietDateElem = document.getElementById('diet-date');
        const workoutDateElem = document.getElementById('workout-date');
        if (dietDateElem) dietDateElem.innerText = formattedDate;
        if (workoutDateElem) workoutDateElem.innerText = formattedDate;
    }

    // This function sends the checked item to the database to be saved
    function logItemToBackend(name, calories, type) {
        fetch('/log_item_from_dashboard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, calories: calories, type: type })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh the page to show the new item in the "Logged" list and update everything
                window.location.reload();
            } else {
                alert('There was an error logging your item. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('A network error occurred.');
        });
    }

    // This function is triggered when a checkbox on the AI plan is clicked
    function handleItemLogging(event) {
        const target = event.target;
        if (target.matches('input[type="checkbox"]')) {
            const item = target.closest('.plan-item');
            
            // Prevents re-logging an item that's already completed or being processed
            if (item.classList.contains('completed') || target.disabled) {
                return; 
            }

            const itemName = item.dataset.name;
            const itemCalories = parseFloat(item.dataset.calories);
            const itemType = item.dataset.type;

            // Disable the checkbox to prevent multiple clicks
            target.disabled = true;
            
            // Save the data to the database
            logItemToBackend(itemName, itemCalories, itemType);
        }
    }

    // Initialize date and attach event listeners
    setTodaysDate();
    const dietList = document.getElementById('diet-list');
    if (dietList) dietList.addEventListener('click', handleItemLogging);
    
    const workoutList = document.getElementById('workout-list');
    if(workoutList) workoutList.addEventListener('click', handleItemLogging);

    // --- JavaScript for Export Modal ---
    const exportBtn = document.getElementById('exportBtn');
    const exportModal = document.getElementById('exportModal');
    const closeModalBtn = document.getElementById('closeModalBtn');

    if (exportBtn) {
        exportBtn.addEventListener('click', () => {
            exportModal.style.display = 'flex';
        });
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
            exportModal.style.display = 'none';
        });
    }

    if (exportModal) {
        exportModal.addEventListener('click', (e) => {
            if (e.target === exportModal) {
                exportModal.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}